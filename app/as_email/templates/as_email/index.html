{% extends "as_email/base.html" %}
{% load static crispy_forms_tags %}
{% block title %}AS Email - Email Accounts{% endblock %}
{% block importmap %}
  <script type="importmap">
   {
     "imports": {
       "vue": "{% static 'js/vue.esm-browser.js' %}",
       "vue-select": "{% static 'js/vue-select.es.js' %}"
     }
   }
  </script>
{% endblock importmap %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/vue-select.css' %}">
{% endblock extra_css %}
{% block defer_compress_js %}
  {{ block.super }}
  <script defer type="module" src="{% static 'as_email/js/app.js' %}"></script>
{% endblock defer_compress_js %}
{% block content %}
  <template id="template-email-account">
    <div>
      <div class="card-content">
        <form action="as_email:email-account-detail" id="email-account-form-5" method="post" name="email-account-form-5">
          <div id="div_id_delivery_method" class="field">
            <label :for="`id-delivery-method-${pk}`" class="label">Delivery method <span v-if="labelErrorMessages.delivery_method" class="error">[[ labelErrorMessages.delivery_method ]]</span></label>
            <div class="control">
              <div class="select">
                <select
                  name="delivery_method"
                  :id="`id-delivery-method-${pk}`"
                  :value="deliveryMethod"
                  @input="$emit('update:deliveryMethod', $event.target.value)"
                >
                  <option value="LD">
                    Local Delivery
                  </option>
                  <option value="AL">
                    Alias
                  </option>
                  <option value="FW">
                    Forwarding
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="control">
              <label :for="`id_autofile_spam-${pk}`" class="checkbox">
                <input type="checkbox" name="autofile_spam"
                  :id="`id_autofile_spam-${pk}`" :checked="autofileSpam" @input="$emit('update:autofileSpam', $event.target.checked)"> Autofile spam</label>
            </div>
            <p id="hint_id_autofile_spam" class="help">When incoming mail exceeds the threshold set in
              `spam_score_threshold` then this email will automatically files in the `spam_delivery_folder`
              mailbox. NOTE: This only apply if local or IMAP delivery is selected in `delivery_method`.</p>
          </div>

          <div class="field">
            <label :for="`id_alias_for-${pk}`" class="label">Alias for <span v-if="labelErrorMessages.alias_for" class="error">[[ labelErrorMessages.alias_for ]]</span></label>
            <div class="control">
              <div class="select is-multiple">
                <select data-type="tags"
                  name="alias_for"
                  :id="`id_alias_for-${pk}`"
                  :value="aliasFor"
                  @change="selectMultiple('update:aliasFor',$event)"
                  multiple>
                  <option v-for="email_addr in filteredValidEmailAddrs">
                    [[ email_addr ]]
                  </option>
                </select>
              </div>
            </div>
          </div>
          <p>[[ aliasFor ]]</p>

          <div class="field">
            <label :for="`id_aliases-${pk}`" class="label">aliases <span v-if="labelErrorMessages.aliases" class="error">[[ labelErrorMessages.aliases ]]</span></label>
            <div class="control">
              <div class="select is-multiple">
                <select data-type="tags"
                  name="aliases"
                  :id="`id_aliases-${pk}`"
                  :value="aliases"
                  @change="selectMultiple('update:aliases',$event)"
                  multiple>
                  <option v-for="email_addr in filteredValidEmailAddrs" :value="email_addr">
                    [[ email_addr ]]
                  </option>
                </select>
              </div>
            </div>
          </div>
          <p>[[ aliases ]]</p>

          <div v-if="deactivated">
            <p>Email Account is deactivated and can not send email: [[ props.deactivatedReason ]]</p>
          </div>
          <div :id="`div_id_forward_to_${pk}`" class="field">
            <label :for="`forward-to-id-${pk}`" class="label">Forward to</label>
            <div class="control">
              <input
                type="email"
                name="forward_to"
                maxlength="254"
                class="input"
                :id="`forward-to-id-${pk}`"
                :value="forwardTo"
                @input="$emit('update:forwardTo', $event.target.value)"
              />
            </div>
          </div>

        </form>
        <span v-if="labelErrorMessages.detail">[[ labelErrorMessages.detail ]]</span>
      </div>
      <footer class="card-footer">
        <p class="card-footer-item">
          <span>
            <input class="button is-primary" @click="submitData" type="submit" value="Apply" :disabled="submitDisabled">
          </span>
        </p>
        <p class="card-footer-item">
          <span>
            <input class="button is-info" @click="resetData" type="reset" value="Reset" :disabled="resetDisabled">
          </span>
        </p>
      </footer>
    </div>
  </template>
  <div class="container">
    <p class="title is-1">Email Accounts</p>

    <div id="asemail-vue-app">
      <h1>[[ myTitle ]]</h1>
      <button @click="update_foo" class="button">Yes</button>

      {% if email_accounts %}
        {% for email_account, email_account_form in email_accounts %}
          <div class="card">
            <header class="card-header">
              <p class="card-header-title">{{email_account.email_address}}</p>
              <a data-action="collapse" data-target="email-account-{{email_account.pk}}" class="card-header-icon is-hidden-fullscreen" aria-label="expand card">
                <span class="icon">
                  <ion-icon name="chevron-down-outline" aria-hidden="true"></ion-icon>
                </span>
              </a>
            </header>
            <div class="is-collapsible"  id="email-account-{{email_account.pk}}">
              <email-account
                @aliases-changed="updateAliases"
                v-model:pk="emailAccountsData.pk{{email_account.pk}}.pk"
                v-model:url="emailAccountsData.pk{{email_account.pk}}.url"
                v-model:email-address="emailAccountsData.pk{{email_account.pk}}.email_address"
                v-model:delivery-method="emailAccountsData.pk{{email_account.pk}}.delivery_method"
                v-model:autofile-spam="emailAccountsData.pk{{email_account.pk}}.autofile_spam"
                v-model:spam-delivery-folder="emailAccountsData.pk{{email_account.pk}}.spam_delivery_folder"
                v-model:spam-score-threshold="emailAccountsData.pk{{email_account.pk}}.spam_score_threshold"
                v-model:alias-for="emailAccountsData.pk{{email_account.pk}}.alias_for"
                v-model:aliases="emailAccountsData.pk{{email_account.pk}}.aliases"

                v-model:forward-to="emailAccountsData.pk{{email_account.pk}}.forward_to"
                v-model:num-bounces="emailAccountsData.pk{{email_account.pk}}.num_bounces"
                v-model:deactivated="emailAccountsData.pk{{email_account.pk}}.deactivated"
                v-model:deactivated-reason="emailAccountsData.pk{{email_account.pk}}.deactivated_reason"
                v-model:valid-email-addresses="initialData.valid_email_addresses"
                v-model:fieldInfo="initialData.email_account_field_info"></email-account>
            </div>
          </div>
        {% endfor %}
      {% else  %}
        <p>{{ user }}, you have no  email accounts.</p>
      {% endif %}
    </div>
  </div>
  {{ vue_data|json_script:"vue-data" }}
{% endblock %}
{% block javascript %}
  <script type="text/javascript">
   // Set APP_DEBUG on the window to indicate if we are in DEBUG mode or not
   // This comes from the `settings.DEBUG` in the django project's config.
   //
   window.APP_DEBUG = {{ settings.DEBUG|lower }};
  </script>
  {{ super.block }}
{% endblock javascript %}
